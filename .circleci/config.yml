version: 2
jobs:
  build:
    docker:
      - image: daewok/sbcl:1.5.2-alpine3.9
    
    working_directory: ~/quicklisp/local-projects/circleci-101

    steps:
      - checkout

      - run:
          name: Install wget
          command: |
            apk update
            apk add wget

      - run:
          name: Download quicklisp
          command: |
            wget https://beta.quicklisp.org/quicklisp.lisp
            cp .sbclrc ~/
            mkdir -p /root/.config/common-lisp
            cp asdf-output-translations.conf /root/.config/common-lisp

      - restore_cache:
          keys:
            - v2-deps-{{ checksum "circleci-101.asd" }}-{{ checksum "circleci-101-test.asd" }}-{{ checksum "quicklisp.lisp" }}
            - v2-deps-

      - run:
          name: Install quicklisp
          command: |
            if [ ! -f ~/quicklisp/setup.lisp ]; then
              cat quicklisp.lisp init-quicklisp.lisp | sbcl
            fi

      - run:
          name: Build
          command: cat build.lisp | sbcl

      - run:
          name: Test
          command: cat test.lisp | sbcl

      - save_cache:
          key: v2-deps-{{ checksum "circleci-101.asd" }}-{{ checksum "circleci-101-test.asd" }}-{{ checksum "quicklisp.lisp" }}
          paths:
            - quicklisp.lisp
            - ~/quicklisp
            - ~/.cache/common-lisp

workflows:
  version: 2

  default:
    jobs:
      - build:
          context: integration_tests

  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - build:
          context: integration_tests